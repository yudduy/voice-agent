# SERIES KILLER - Supabase Database Schema

## Project Information
- **Project ID**: `rdnduoxlgutqgczlfvgy`
- **Region**: `us-east-2`
- **Status**: `ACTIVE_HEALTHY`
- **Database**: PostgreSQL 17.4.1.048
- **Environment**: Production

## Schema Overview

### Auth Schema (Supabase Managed)

#### `auth.users`
**Purpose**: Core Supabase authentication users table  
**Type**: System table (managed by Supabase Auth)

**Key Columns**:
- `id` (UUID, PK) - Primary user identifier
- `phone` (TEXT, UNIQUE) - Phone number in E.164 format
- `email` (VARCHAR, UNIQUE) - Email address  
- `created_at` (TIMESTAMPTZ) - User creation timestamp
- `phone_confirmed_at` (TIMESTAMPTZ) - Phone verification timestamp
- `email_confirmed_at` (TIMESTAMPTZ) - Email verification timestamp
- `raw_user_meta_data` (JSONB) - Custom user metadata
- `raw_app_meta_data` (JSONB) - Application metadata

**Foreign Key Relationships**: Referenced by all public schema tables

---

### Public Schema (Application Tables)

#### `phone_links`
**Purpose**: Maps phone numbers to Supabase auth users  
**RLS**: Enabled

**Schema**:
```sql
CREATE TABLE phone_links (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id UUID REFERENCES auth.users(id),
    phone_number TEXT NOT NULL UNIQUE,
    verified BOOLEAN DEFAULT false,
    verification_code TEXT,
    verification_attempts INTEGER DEFAULT 0,
    last_verification_attempt TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**Key Features**:
- One-to-one mapping between phone numbers and users
- SMS verification workflow support
- E.164 phone number format required
- Verification attempt tracking and rate limiting

---

#### `preferences`
**Purpose**: Stores user-specific application preferences  
**RLS**: Enabled

**Schema**:
```sql
CREATE TABLE preferences (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id UUID NOT NULL UNIQUE REFERENCES auth.users(id),
    voice_preference TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**Key Features**:
- One preferences record per user
- TTS voice selection storage
- Extensible for additional user preferences

---

#### `call_history`
**Purpose**: Logs completed voice call sessions  
**RLS**: Enabled

**Schema**:
```sql
CREATE TABLE call_history (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id UUID REFERENCES auth.users(id),
    phone_number TEXT NOT NULL,
    call_sid TEXT NOT NULL UNIQUE,
    call_status TEXT,
    duration INTEGER,
    transcript TEXT,
    summary TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**Key Features**:
- Complete call session logging
- Twilio Call SID tracking
- Full conversation transcript storage
- AI-generated call summaries
- Call duration and status tracking

**Status Values**:
- `initiated` - Call started
- `ringing` - Phone ringing
- `in-progress` - Call answered and active
- `completed` - Call finished successfully
- `busy` - Phone busy
- `failed` - Call failed
- `no-answer` - No one answered

---

#### `sms_history`  
**Purpose**: Logs inbound and outbound SMS messages  
**RLS**: Enabled

**Schema**:
```sql
CREATE TABLE sms_history (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id UUID REFERENCES auth.users(id),
    phone_number TEXT NOT NULL,
    message_sid TEXT NOT NULL UNIQUE,
    direction TEXT NOT NULL,
    content TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**Key Features**:
- Bidirectional SMS logging
- Twilio Message SID tracking
- Direction tracking (`inbound`/`outbound`)
- Complete message content storage

---

#### `user_profiles`
**Purpose**: Extended user profile data and onboarding tracking  
**RLS**: Enabled

**Schema**:
```sql
CREATE TABLE user_profiles (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id UUID NOT NULL UNIQUE REFERENCES auth.users(id),
    first_name TEXT NOT NULL,
    last_name TEXT NOT NULL,
    location TEXT,
    onboarding_status TEXT NOT NULL DEFAULT 'pending',
    phone_verified BOOLEAN DEFAULT false,
    onboarding_sent_at TIMESTAMPTZ,
    onboarding_completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**Onboarding Status Values**:
- `pending` - User created, onboarding not started
- `sms_sent` - Onboarding SMS sent
- `completed` - Onboarding process completed
- `failed` - Onboarding process failed

---

#### `onboarding_messages`
**Purpose**: Tracks onboarding SMS messages sent to new users  
**RLS**: Enabled

**Schema**:
```sql
CREATE TABLE onboarding_messages (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id UUID NOT NULL REFERENCES auth.users(id),
    phone_number TEXT NOT NULL,
    message_type TEXT NOT NULL,
    message_sid TEXT,
    status TEXT DEFAULT 'pending',
    content TEXT NOT NULL,
    sent_at TIMESTAMPTZ,
    delivered_at TIMESTAMPTZ,
    error_message TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**Message Types**:
- `welcome` - Initial welcome message
- `verification` - Phone verification message
- `reminder` - Follow-up reminder message

**Status Values**:
- `pending` - Message queued for sending
- `sent` - Message sent to Twilio
- `delivered` - Message delivered to phone
- `failed` - Message delivery failed

---

## Data Relationships

```
auth.users (1) ←→ (1) user_profiles
auth.users (1) ←→ (1) preferences  
auth.users (1) ←→ (1) phone_links
auth.users (1) ←→ (*) call_history
auth.users (1) ←→ (*) sms_history
auth.users (1) ←→ (*) onboarding_messages
```

## Integration Test Functions

### `create_integration_test_user(p_id UUID, p_phone TEXT, p_email TEXT)`
**Purpose**: Creates minimal auth.users records for integration testing  
**Returns**: JSON with user ID and status  
**Security**: DEFINER (uses elevated privileges)

**Usage**:
```sql
SELECT create_integration_test_user(
    'uuid-here'::UUID,
    '19713364433',
    'test@integration.test'
);
```

## Row Level Security (RLS)

All public schema tables have RLS enabled with the following policy pattern:
- **Service Role**: Full access (used by application backend)
- **Authenticated Users**: Access to own records only (user_id = auth.uid())
- **Anonymous**: No access

## API Access

- **REST API**: `https://rdnduoxlgutqgczlfvgy.supabase.co/rest/v1/`
- **Auth API**: `https://rdnduoxlgutqgczlfvgy.supabase.co/auth/v1/`
- **Realtime**: `wss://rdnduoxlgutqgczlfvgy.supabase.co/realtime/v1/`

## Current Data Stats

- **Total Tables**: 6 (public schema)
- **Active Users**: 1+ (test users)
- **Call History Records**: 10+ (from integration testing)
- **Phone Links**: 1+ (verified test numbers)

## Notes for NYC HACKS

- All foreign key constraints properly enforced
- Integration test validates full voice call flow
- Ready for production voice bot deployment
- Comprehensive logging for debugging and analytics
- Scalable architecture for multiple users and concurrent calls